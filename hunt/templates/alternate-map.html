{% load static %}
<!DOCTYPE html>
<html style="font-size: 17px">
  <head>
    <link rel="stylesheet" href="{% static "map-style.css" %}">
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat&amp;display=swap"
      rel="stylesheet"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>eTreasure Hunt</title>
    <style>
      .top {
        background-image: url("{% static "colors.png" %}");
      }
    </style>
  </head>

  <body>
    <header class="top">
      <div class="left"><a href="/">HOME</a></div>
      <div class="right"><a href="/accounts/logout?next=/">Log out</a></div>
    </header>

    <div id="map"></div>
    <button
      id="searchbutton"
      class="gobutton alt-gobutton"
      style="font-size: 0.9rem; position:absolute; bottom: 10px; left: 50%; -webkit-transform: translateX(-50%); transform: translateX(-50%) z-index: 2;"
      onclick="Action()"
    >
      SEARCH HERE
    </button>

    <!-- Load Leaflet from CDN -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin=""
    ></script>

    <!-- Load Esri Leaflet from CDN -->
    <script
      src="https://unpkg.com/esri-leaflet@2.5.3/dist/esri-leaflet.js"
      integrity="sha512-K0Vddb4QdnVOAuPJBHkgrua+/A9Moyv8AQEWi0xndQ+fqbRfAFd47z4A9u1AW/spLO0gEaiE1z98PK1gl5mC5Q=="
      crossorigin=""
    ></script>

    <!-- Load Esri Leaflet Geocoder from CDN -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/esri-leaflet-geocoder@2.3.3/dist/esri-leaflet-geocoder.css"
      integrity="sha512-IM3Hs+feyi40yZhDH6kV8vQMg4Fh20s9OzInIIAc4nx7aMYMfo+IenRUekoYsHZqGkREUgx0VvlEsgm7nCDW9g=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/esri-leaflet-geocoder@2.3.3/dist/esri-leaflet-geocoder.js"
      integrity="sha512-HrFUyCEtIpxZloTgEKKMq4RFYhxjJkCiF5sDxuAokklOeZ68U2NPfh4MFtyIVWlsKtVbK5GD2/JzFyAfvT5ejA=="
      crossorigin=""
    ></script>

    <script>
      // Initialize the map and assign it to a variable for later use
      var map = L.map("map", {
        // Set latitude and longitude of the map center (required)
        center: [30, 0],
        // Set the initial zoom level, values 0-18, where 0 is most zoomed-out (required)
        zoom: 3,
      });

      var latlng;
      var search_button = document.getElementById("searchbutton");
      search_button.disabled = true;
      search_button.classList.add("disabled");

      // Create a Tile Layer and add it to the map
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      var searchControl = new L.esri.Geocoding.geosearch({
        placeholder: "Begin typing for suggestions",
        useMapBounds: "false",
      }).addTo(map);
      map.zoomControl.setPosition("topright");

      var results = new L.LayerGroup().addTo(map);
      L.control.scale().addTo(map);

      searchControl.on("results", function (data) {
        results.clearLayers();
        latlng = data.results[0].latlng;
        results.addLayer(L.marker(latlng, { draggable: "true" }));

        search_button.disabled = false;
        search_button.classList.remove("disabled");
      });

      map.on("click", function (e) {
        results.clearLayers();
        latlng = e.latlng;
        results.addLayer(L.marker(latlng, { draggable: "true" }));
        search_button.disabled = false;
        search_button.classList.remove("disabled");
      });

      function Action() {
        if (latlng != null && latlng != undefined) {
          var url = new URL(window.location);
          var lvl = url.searchParams.get("lvl");
          var href_string =
            "/do-search?lat=" + latlng.lat + "&long=" + latlng.lng;

          if (lvl != null) {
            href_string += "&lvl=" + lvl;
          }

          window.location.href = href_string;
        }
      }
    </script>
  </body>
</html>
